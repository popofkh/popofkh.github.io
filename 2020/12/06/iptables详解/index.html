<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="本文参考、整理自： 《云原生服务网格Istio原理、实践、架构与源码解析》https:&#x2F;&#x2F;book.douban.com&#x2F;subject&#x2F;34438220&#x2F; 朱双印个人日志：iptables详解系列 http:&#x2F;&#x2F;www.zsythink.net&#x2F;archives&#x2F;tag&#x2F;iptables&#x2F;  iptables的基本原理概念我们通常所说的iptables严格来讲应该叫做Netfilter，Net">
<meta property="og:type" content="article">
<meta property="og:title" content="iptables详解">
<meta property="og:url" content="http://example.com/2020/12/06/iptables%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="popoのblog">
<meta property="og:description" content="本文参考、整理自： 《云原生服务网格Istio原理、实践、架构与源码解析》https:&#x2F;&#x2F;book.douban.com&#x2F;subject&#x2F;34438220&#x2F; 朱双印个人日志：iptables详解系列 http:&#x2F;&#x2F;www.zsythink.net&#x2F;archives&#x2F;tag&#x2F;iptables&#x2F;  iptables的基本原理概念我们通常所说的iptables严格来讲应该叫做Netfilter，Net">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_6.png">
<meta property="og:image" content="http://www.zsythink.net/wp-content/uploads/2017/05/051517_1411_1.png">
<meta property="article:published_time" content="2020-12-06T07:27:06.000Z">
<meta property="article:modified_time" content="2020-12-12T15:12:50.443Z">
<meta property="article:author" content="popo_fkh">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="网络">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_6.png">

<link rel="canonical" href="http://example.com/2020/12/06/iptables%E8%AF%A6%E8%A7%A3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>iptables详解 | popoのblog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">popoのblog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/06/iptables%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="popo_fkh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="popoのblog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          iptables详解
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-06 15:27:06" itemprop="dateCreated datePublished" datetime="2020-12-06T15:27:06+08:00">2020-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-12 23:12:50" itemprop="dateModified" datetime="2020-12-12T23:12:50+08:00">2020-12-12</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>本文参考、整理自：</p>
<p>《云原生服务网格Istio原理、实践、架构与源码解析》<a target="_blank" rel="noopener" href="https://book.douban.com/subject/34438220/">https://book.douban.com/subject/34438220/</a></p>
<p>朱双印个人日志：iptables详解系列 <a target="_blank" rel="noopener" href="http://www.zsythink.net/archives/tag/iptables/">http://www.zsythink.net/archives/tag/iptables/</a></p>
</blockquote>
<h1 id="iptables的基本原理"><a href="#iptables的基本原理" class="headerlink" title="iptables的基本原理"></a>iptables的基本原理</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>我们通常所说的iptables严格来讲应该叫做<code>Netfilter</code>，<code>Netfilter</code>是一种内核防火墙框架，可以实现很多网络安全策略，包括数据包过滤、数据包处理、地址伪装、透明代理、网络地址转换等。<code>iptables</code>则是一个应用层的二进制工具，可以基于<code>Netfilter</code>接口设置内核中的<code>Netfilter</code>配置表。</p>
<p><code>iptables</code>由表及构成表的链组成，每条链又由具体的规则组成。iptables内置4张表和5条链，4张表分别是RAW、Mangle、NAT、Filter表，5条链又叫作数据包的5个挂载点（Hook Point，可以理解为回调函数点，在数据包到达这些位置时，内核回主动调用回调函数，使得数据包在路由时可以改变方向或内容），分别是PREROUTING、INPUT、OUTPUT、FORWORD和POSTROUTING。对于不同表中相同类型的规则执行顺序，iptabels定义了优先级，该优先级由高到低排序为raw、managle、nat、filter。例如，对于PREROUTING链来说，首先执行raw表的规则，然后执行mangle表的规则，最后执行nat表的规则。</p>
<h2 id="iptables的表和链"><a href="#iptables的表和链" class="headerlink" title="iptables的表和链"></a>iptables的表和链</h2><p>Filter表表示iptables的默认表，如果在创建规则时未指定表，那么默认使用Filter表，主要用于数据包过滤，根据具体规则决定是否放行该数据包（DROP、ACCEPT、REJECT、LOG等）。</p>
<p>Filter表包含如下三种内建链：</p>
<ul>
<li>INPUT链：过滤目的地址是本机的所有数据包</li>
<li>OUTPUT链：过滤本机产生的所有数据包</li>
<li>FORWARD链：过滤经过本机的所有数据包（源地址和目的地址都不是本机）</li>
</ul>
<p>NAT表主要用于修改数据包的IP地址、端口号等信息，包含以下三种内建链</p>
<ul>
<li>PREROUTING链：DNAT，处理刚到达本机并在路由转发前转换数据包的目的地址</li>
<li>POSTROUTING链：SNAT，处理即将离开本机的数据包，转换数据包的源地址</li>
<li>OUTPUT链：MASQUERADE，改变本机产生的数据包的源地址</li>
</ul>
<p>主要用于修改数据包的TOS、TTL，以及为数据包设置Mark标记，以实现QoS调整及策略路由等。它包含所有5条内置规则链：PREROUTING、POSTROUTING、INPUT、OUTPUT、FORWORD。</p>
<p>RAW表是iptables在1.2.9版本之后新增的表，主要用于决定数据包是否被状态跟踪机制处理。RAW表的优先级要优于其他表，包含两条规则链：OUTPUT和PREROUTING。</p>
<h2 id="iptables原理图"><a href="#iptables原理图" class="headerlink" title="iptables原理图"></a>iptables原理图</h2><p><img src="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_6.png" alt="iptables详解（1）：iptables概念"></p>
<p>上图展示了iptables规则链处理数据包的顺序，网卡接收的数据包会进入内核协议栈被PREROUTING规则链处理（可能发生数据包的目的地址转换），之后由内核协议栈进行路由选择，如果数据包的目的地址是本机，则内核协议栈会将其传给INPUT链处理，INPUT链在允许通过后，数据包由内核空间进入用户空间，被主机进程处理；如果PREROUTING链处理后的数据报的目的地址不是本机地址，则将其传给FORWARD链进行处理，最后交给POSTROUTING链。本机进程发出的数据包首先进行路由选择，经过OUTPUT链后，到达POSTROUTING链（可能发生数据包的源地址转换）。</p>
<h1 id="iptables的基本使用"><a href="#iptables的基本使用" class="headerlink" title="iptables的基本使用"></a>iptables的基本使用</h1><h2 id="规则查询"><a href="#规则查询" class="headerlink" title="规则查询"></a>规则查询</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables --line-number -t filter -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 750 packets, 50472 bytes)</span><br><span class="line">num    pkts    bytes    target    prot    opt    in    out    source    destination          </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 选项</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --line-number 显示行号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -t 指定表，默认为filter表</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -n 直接显示IP地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -v 显示详细信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -x 显示精确的收发包大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -L 指定链，不指定链名默认所有链</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 结果</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> policy 当前链的默认策略</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pkts 当前链默认策略匹配到的包的数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bytes 当前链默认策略匹配到的包的大小总和</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> num 行号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pkts 当前规则匹配到的数据包数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bytes 当前规则匹配到的数据包大小总和</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 当前规则的效果</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> prot 当前规则的匹配的数据包网络协议</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> opt</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> out</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> 源地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> destination 目的地址</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="规则管理"><a href="#规则管理" class="headerlink" title="规则管理"></a>规则管理</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -s 192.168.1.146 -j REJECT</span><br><span class="line">[root@localhost ~]# iptables -nvxL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 49 packets, 2900 bytes)</span><br><span class="line">pkts  bytes  target  prot  opt  in  out  source         destination         </span><br><span class="line">0     0      REJECT  all   --   *   *    192.168.1.146  0.0.0.0/0     reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> -t 指定表名，默认为filter表</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 规则管理动作：-I 首部插入  -A 尾部追加  -D 删除  -F 刷新链(删除链中所有规则)  -R 修改规则(必须指定原匹配条件和匹配效果)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 规则匹配条件: -s 源IP　-d 目的IP</span>  </span><br><span class="line"><span class="meta">#</span><span class="bash"> -j 规则效果: ACCEPT通过  DROP丢弃  REJECT拒绝</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改链的默认规则效果</span></span><br><span class="line">[root@localhost ~]# iptables -P FORWARD DROP</span><br><span class="line">[root@localhost ~]# iptables -nvxL FORWARD</span><br><span class="line">Chain FORWARD (policy DROP 0 packets, 0 bytes)</span><br><span class="line">pkts    bytes    target    prot    opt    in    out    source    destination</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存规则</span></span><br><span class="line">[root@localhost ~]# iptables-save &gt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure>

<h2 id="规则匹配条件"><a href="#规则匹配条件" class="headerlink" title="规则匹配条件"></a>规则匹配条件</h2><h3 id="基本匹配条件"><a href="#基本匹配条件" class="headerlink" title="基本匹配条件"></a>基本匹配条件</h3><p><strong>源IP/目的IP地址</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定单个地址</span></span><br><span class="line">iptables -t filter -I INPUT -s[d] 192.168.4.129 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定多个地址</span></span><br><span class="line">iptables -t filter -I INPUT -s[d] 192.168.4.129,192.168.4.130 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定网段</span></span><br><span class="line">iptables -t filter -I INPUT -s[d] 192.168.4.0.0/16 -j DROP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 取反</span></span><br><span class="line">iptables -t filter -I INPUT ! -s[d] 192.168.4.129 -j DROP</span><br></pre></td></tr></table></figure>

<blockquote>
<p>假设在空的INPUT链中添加如下规则：</p>
<p><code>iptables -t filter -I INPUT ! -s 192.168.4.129 -j DROP</code></p>
<p>那么当IP为192.168.4.129的主机ping本机时，首先对比源IP和规则中的IP，发现不符合规则的匹配条件，会进入INPUT链的默认处理策略，即ACCEPT，因此IP为192.168.4.129的主机可以收到ICMP响应包。</p>
</blockquote>
<p><strong>协议类型</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -s 192.168.4.129 -p tcp -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> iptables支持的协议类型</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tcp, udp, udplite, icmp, icmpv6,esp, ah, sctp, mh 不指定协议时默认匹配所有协议</span></span><br></pre></td></tr></table></figure>

<p><strong>网卡接口</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -i eth0 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> -i 匹配数据包流入网卡，只能用于PREROUTING、INPUT、FORWARD链</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o 匹配数据包流出网卡，只能用于OUTPUT、FORWARD、POSTROUTING链</span></span><br></pre></td></tr></table></figure>

<h3 id="扩展匹配条件"><a href="#扩展匹配条件" class="headerlink" title="扩展匹配条件"></a>扩展匹配条件</h3><p>上面讲的都是iptabls的基本匹配条件，端口号属于扩展匹配条件。对于基本匹配条件，如果需要使用扩展匹配条件，则需要一些扩展模块的支持。</p>
<p><strong>tcp扩展</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 端口号</span></span><br><span class="line">iptables -t filter -I INPUT -s 192.168.4.129 -p tcp [-m tcp] --dport 22 -j REJECT</span><br><span class="line">iptables -t filter -I INPUT -s 192.168.4.129 -p udp [-m udp] --sport 30000:36655 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> -m 指定扩展模块名，如不指定，会默认使用-m 协议名</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --dport/--sport 指定端口范围</span></span><br><span class="line">iptables -t filter -I INPUT -s 192.168.4.129 -p tcp -m mutiport --dport 22,23:25 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> -m mutiport 扩展模块可以同时指定多个离散的端口或端口范围</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP标志位</span></span><br><span class="line">iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH[ALL] SYN -j REJCET</span><br><span class="line"><span class="meta">#</span><span class="bash"> --tcp-flags 指定了TCP报文中的标志位。第一个参数表示要匹配报文TCP头中的哪些标志位，第二个参数表示第一个参数列表中标志位必须为1的标志(其他标志必须为0)</span></span><br></pre></td></tr></table></figure>

<p><strong>udp扩展</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -p udp -m udp --dport 137 -j REJECT</span><br></pre></td></tr></table></figure>

<p><strong>icmp扩展</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -p icmp -m icmp --icmp-type 8/0 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> --icmp-type 指定icmp报文类型，8表示icmp <span class="built_in">type</span>，0表示icmp code</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> https://tools.ietf.org/html/rfc792</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> https://zh.wikipedia.org/wiki/%E4%BA%92%E8%81%94%E7%BD%91%E6%8E%A7%E5%88%B6%E6%B6%88%E6%81%AF%E5%8D%8F%E8%AE%AE</span></span><br></pre></td></tr></table></figure>

<p><strong>iprange扩展</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -m iprange --src-range 192.168.4.127-192.168.4.131 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> iprange模块匹配数据包的源IP或目的IP地址范围(--dst-range)</span></span><br></pre></td></tr></table></figure>

<p><strong>string扩展</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -m string --algo bm --string &quot;OOXX&quot; -j REJCET</span><br><span class="line"><span class="meta">#</span><span class="bash"> string模块用于匹配字符串</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --algo 指定算法，支持bm算法或kmp算法</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --string 指定待匹配的字符串</span></span><br></pre></td></tr></table></figure>

<p><strong>time扩展</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -m time --timestart 09:00:00 --timestop 11:00:00 --weekdays 1,2,3,4,5 --monthdays 22,23,24 --datestart 2020-07-01 --datestop 2020-09-01 -j REJCET</span><br><span class="line"><span class="meta">#</span><span class="bash"> time 模块用于匹配时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --timestart/--timestop 指定一天内的时间段</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --weekdays/--monthdays 指定一周/月内的哪几天</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --datestart/--datestop 指定起始和结束日期</span></span><br></pre></td></tr></table></figure>

<p><strong>connlimit扩展</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 2 --connlimit-mask 24 -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> connlimit 模块用于设置连接数限制</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --connlimit-above 指定每个客户IP的并发连接数上限</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --connlimit-mask 指定客户IP的网段(掩码长度)</span></span><br></pre></td></tr></table></figure>

<p><strong>limit扩展</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 假设现在要设置这样一条规则：每6s响应1次(1min响应10次)icmp报文</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方式一</span></span><br><span class="line">iptables -t filter -I INPUT -p icmp -m limit --limit 10/minute -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">limit</span> 模块提供了速率限制功能</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --<span class="built_in">limit</span> 指定匹配时间间隔</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 效果一：第6秒的报文匹配到了该规则，执行了放行操作；而第6秒前的报文没有匹配到该规则，会执行默认策略即ACCEPT，也就是说该规则实际上没有起到任何效果</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方式二</span></span><br><span class="line">iptables -t filter -I INPUT -p icmp -m limit --limit 10/minute -j ACCEPT</span><br><span class="line">iptables -t filter -I INPIT -p icmp -j REJECT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 效果二：只有被第一条规则匹配的到数据包会放行，其余的被REJECT掉，能够实现限流的功能。但实际测试会发现前5个报文没有被限流(都被放行了)，原因在于<span class="built_in">limit</span>模块默认参数--limit-burst=5。该参数与令牌桶算法有关。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>令牌桶算法</p>
<p>有一个木桶，木桶里面放了5块令牌（–limit-burst），所有报文如果想要出关入关，都必须要持有木桶中的令牌才行，这个木桶每隔6秒钟会生成一块新的令牌。如果木桶中的令牌不足5块，新生成的令牌会被放入木桶中，否则令牌被丢弃。如果此时有5个报文想要入关，恰好这5个报文能在木桶里找到一人一个令牌，于是报文被放行；此时木桶中已经没有令牌可以使用了，因此剩余的报文被拒绝。但每6秒钟，会生成新的令牌，新的报文获取到该令牌后，再此被放行。令牌可积累，但木桶最多能存放的令牌数只有5个。</p>
</blockquote>
<h2 id="规则动作"><a href="#规则动作" class="headerlink" title="规则动作"></a>规则动作</h2><p>规则动作也包括基础动作与扩展动作，与扩展匹配条件不同，扩展动作可以直接使用，而不需要指定特定模块。</p>
<h3 id="基础动作"><a href="#基础动作" class="headerlink" title="基础动作"></a>基础动作</h3><p><strong>ACCEPT</strong></p>
<p><strong>DROP</strong></p>
<h3 id="扩展动作"><a href="#扩展动作" class="headerlink" title="扩展动作"></a>扩展动作</h3><p><strong>REJECT</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -p tcp --dport 22 -j REJECT --reject-with icmp-host-unreachable</span><br><span class="line"><span class="meta">#</span><span class="bash"> --reject-with 指定拒绝提示信息，默认为icmp-host-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可用值如下：icmp-net-unreachable/icmp-host-unreachable/icmp-port-unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> icmp-proto-unreachable/icmp-net-prohibited/icmp-host-pro-hibited/icmp-admin-prohibited</span></span><br></pre></td></tr></table></figure>

<p><strong>LOG</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter - I INPUT -p tcp --dport 22 -j LOG --log-level info --log-prefix &quot;log in from port 22&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> LOG动作会把符合条件的请求记录到日志中，默认的日志地址为/var/<span class="built_in">log</span>/messages</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改日志地址：/etc/rsylog.conf文件中添加kern.warning /var/<span class="built_in">log</span>/iptables.log，重起systemctl restart rsyslog</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --log-level 指定日志级别，可选值：emerg/alert/crit/error/warning/notice/info/debug</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --log-prefix 指定日志前缀(标签)</span></span><br></pre></td></tr></table></figure>

<p><strong>NAT</strong></p>
<blockquote>
<p>网络地址转换</p>
<p>假设网络内部有10台主机，它们有各自的IP地址，当网络内部的主机与其他网络中的主机通讯时，则会暴露自己的IP地址，如果我们想要隐藏这些主机的IP地址，该怎么办呢？</p>
<p>当网络内部的主机向网络外部主机发送报文时，报文会经过防火墙或路由器，当报文经过防火墙或路由器时，将报文的源IP修改为防火墙或者路由器的IP地址，当其他网络中的主机收到这些报文时，显示的源IP地址则是路由器或者防火墙的，而不是那10台主机的IP地址，这样，就起到隐藏网络内部主机IP的作用，当网络内部主机的报文经过路由器时，路由器会维护一张NAT表，表中记录了报文来自于哪个内部主机的哪个进程（内部主机IP+端口），当报文经过路由器时，路由器会将报文的内部主机源IP替换为路由器的IP地址，把源端口也映射为某个端口，NAT表会把这种对应关系记录下来。</p>
<p>示意关系如下：</p>
<p><img src="http://www.zsythink.net/wp-content/uploads/2017/05/051517_1411_1.png" alt="iptables详解（13）：iptables动作总结之二"></p>
<p>于是，外部主机收到报文时，源IP与源端口显示的都是路由的IP与端口，当外部网络中的主机进行回应时，外部主机将响应报文发送给路由器，路由器根据刚才NAT表中的映射记录，将响应报文中的目标IP与目标端口再改为内部主机的IP与端口号，然后再将响应报文发送给内部网络中的主机。整个过程中，外部主机都不知道内部主机的IP地址，内部主机还能与外部主机通讯，于是起到了隐藏网络内主机IP的作用。</p>
<p>内部网络的报文发送出去时，报文的源IP会被修改，也就是源地址转换：Source Network Address Translation，缩写为SNAT。</p>
<p>外部网络的报文响应时，响应报文的目标IP会再次被修改，也就是目标地址转换：Destinationnetwork address translation，缩写为DNAT。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 10.1.0.0/16 -j SNAT --to-source public-IP</span><br><span class="line"><span class="meta">#</span><span class="bash"> SNAT动作只能配置在POSTROUTING、OUTPUT、FORWARD链上</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --to-source 指定源IP(公网IP)</span></span><br><span class="line"></span><br><span class="line">iptables -t nat -I PREROUTING -d public-IP -p tcp --dport public-PORT -j DNAT --to-destination private-IP:private-PORT</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.1.0.0/16 -j SNAT --to-source public-IP</span><br><span class="line"><span class="meta">#</span><span class="bash"> DNAT动作只能配置在PREROUTING、INPUT、FORWARD链上</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --to-destination 指定目的IP(私网IP)</span></span><br></pre></td></tr></table></figure>

<p><strong>MASQUERADE</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 10.1.0.0/16 -o eth0 -j MASQUERADE</span><br><span class="line"><span class="meta">#</span><span class="bash"> MASQUERADE 动态获取有效IP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o 指定从那个网卡获取IP</span></span><br></pre></td></tr></table></figure>

<p><strong>REDIRECT</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080</span><br><span class="line"><span class="meta">#</span><span class="bash"> REDIRECT 端口映射，只能定义在PREROUTING链或者OUTPUT链中</span></span><br></pre></td></tr></table></figure>

<h2 id="自定义链"><a href="#自定义链" class="headerlink" title="自定义链"></a>自定义链</h2><p>当iptables链中的规则很多时，非常难以管理，比如在大量的规则中有些是针对httpd服务的，有些是针对sshd服务的，有针对私网IP的，有针对公网IP的。如果修改一条规则需要查看其他所有规则的话，将会大大降低效率，因此iptables提供了自定义链的能力。但自定义链并不能直接使用，而是需要被默认链引用才能够使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在filter表中创建IN_WEB自定义链</span></span><br><span class="line">iptables -t filter -N IN_WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在INPUT链中引用自定义链</span></span><br><span class="line">iptables -t filter -I INPUT -p tcp --dport 80 -j IN_WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重命名自定义链</span></span><br><span class="line">iptables -E IN_WEB WEB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除引用计数为0并且不包含任何规则的自定义链</span></span><br><span class="line">iptables -X WEB</span><br></pre></td></tr></table></figure>

<h1 id="iptables实战分析"><a href="#iptables实战分析" class="headerlink" title="iptables实战分析"></a>iptables实战分析</h1>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2020/12/12/Linux%E7%BD%91%E7%BB%9C%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="next" title="Linux网络虚拟化——虚拟网络设备">
      Linux网络虚拟化——虚拟网络设备 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">iptables的基本原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables%E7%9A%84%E8%A1%A8%E5%92%8C%E9%93%BE"><span class="nav-number">1.2.</span> <span class="nav-text">iptables的表和链</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="nav-number">1.3.</span> <span class="nav-text">iptables原理图</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">iptables的基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.1.</span> <span class="nav-text">规则查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E7%AE%A1%E7%90%86"><span class="nav-number">2.2.</span> <span class="nav-text">规则管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E5%8C%B9%E9%85%8D%E6%9D%A1%E4%BB%B6"><span class="nav-number">2.3.</span> <span class="nav-text">规则匹配条件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%8C%B9%E9%85%8D%E6%9D%A1%E4%BB%B6"><span class="nav-number">2.3.1.</span> <span class="nav-text">基本匹配条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8C%B9%E9%85%8D%E6%9D%A1%E4%BB%B6"><span class="nav-number">2.3.2.</span> <span class="nav-text">扩展匹配条件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E5%8A%A8%E4%BD%9C"><span class="nav-number">2.4.</span> <span class="nav-text">规则动作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%8A%A8%E4%BD%9C"><span class="nav-number">2.4.1.</span> <span class="nav-text">基础动作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%A8%E4%BD%9C"><span class="nav-number">2.4.2.</span> <span class="nav-text">扩展动作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%93%BE"><span class="nav-number">2.5.</span> <span class="nav-text">自定义链</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables%E5%AE%9E%E6%88%98%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">iptables实战分析</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="popo_fkh"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">popo_fkh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">popo_fkh</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
